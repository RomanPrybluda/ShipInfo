name: Build, publish and deploy to MonsterASP.NET

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build_and_deploy:
    runs-on: windows-latest
    steps:
      - name: üõé Checkout repository
        uses: actions/checkout@v4

      - name: üõ† Setup .NET 8 SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0
          
      - name: üì¶ Restore dependencies
        run: dotnet restore  
        
      - name: üîß Replace appsettings.json values
        shell: pwsh
        run: |
          # –ù–∞–π–¥—ë–º appsettings.json
          $appSettingsPath = Get-ChildItem -Path . -Recurse -Filter "appsettings.json" | Select-Object -First 1 -ExpandProperty FullName
          if (-not $appSettingsPath) {
              Write-Host "‚ùå appsettings.json not found!"
              exit 1
          }      

          $jsonContent = Get-Content $appSettingsPath -Raw | ConvertFrom-Json      

          if ($jsonContent.PSObject.Properties.Name -contains "ConnectionStrings" -and
              $jsonContent.ConnectionStrings.PSObject.Properties.Name -contains "Default") {    

              $jsonContent.ConnectionStrings.Default = "${{ secrets.SHIP_INFO_CONNECTION_STRING }}"
      
              $jsonContent | ConvertTo-Json -Depth 10 | Set-Content $appSettingsPath -Encoding UTF8
      
              Write-Host "‚úÖ Successfully updated ConnectionStrings.Default in: $appSettingsPath"
          } else {
              Write-Host "‚ö†Ô∏è ConnectionStrings.Default not found in appsettings.json!"
              exit 1
          }

      - name: üß± Build project
        run: dotnet build --configuration Release --no-restore
        
      - name: üöÄ Publish project
        run: dotnet publish --configuration Release --output ./publish --runtime win-x86 

      - name: üß™ Run tests
        run: dotnet test

      - name: üìÅ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞–ø–∫–∞ api –¥–æ–ª–∂–Ω–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
        run: |
          echo "‚ö†Ô∏è –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–∞–ø–∫–∞ 'api' —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –¥–æ –Ω–∞—á–∞–ª–∞ –¥–µ–ø–ª–æ—è."
          echo "–ï—Å–ª–∏ WebDeploy –Ω–∞—Å—Ç—Ä–æ–µ–Ω –Ω–∞ –æ—á–∏—Å—Ç–∫—É ‚Äî –ø–∞–ø–∫–∞ –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–∞ –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º."
          echo "–°–æ–∑–¥–∞–π—Ç–µ –µ—ë –≤—Ä—É—á–Ω—É—é –≤ site\\wwwroot\\api, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ."

      - name: üöö Deploy to MonsterASP.NET via WebDeploy
        uses: rasmusbuchholdt/simply-web-deploy@2.1.0
        with:
          website-name: ${{ secrets.SHIP_INFO_WEBSITE_NAME }}
          server-computer-name: ${{ secrets.SHIP_INFO_SERVER_COMPUTER_NAME }}
          server-username: ${{ secrets.SHIP_INFO_SERVER_USERNAME }}
          server-password: ${{ secrets.SHIP_INFO_SERVER_PASSWORD }}
          source-path: ./publish
          target-path: api
