name: Build, publish and deploy to MonsterASP.NET

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build_and_deploy:
    runs-on: windows-latest

    steps:
      # 1) Checkout
      - name: ‚è¨ Checkout repository
        uses: actions/checkout@v4

      # 2) .NET 8 SDK
      - name: üõ† Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0

      # 3) NuGet.org
      - name: üì• Ensure NuGet.org is available
        run: dotnet nuget add source https://api.nuget.org/v3/index.json --name nuget.org

      # 4) Restore
      - name: üì¶ Install dependencies
        run: dotnet restore

      # 5) Replace connection string
      - name: üßæ Replace appsettings.json values
        shell: pwsh
        run: |
          $appSettingsPath = Get-ChildItem -Path $PWD -Recurse -Filter "appsettings.json" | Select-Object -First 1 -ExpandProperty FullName
          if (-not $appSettingsPath) {
              Write-Host "‚ùå appsettings.json not found!"
              exit 1
          }
          $json = Get-Content $appSettingsPath -Raw | ConvertFrom-Json
          if ($json.ConnectionStrings.Default) {
            $json.ConnectionStrings.Default = "${{ secrets.SHIP_INFO_CONNECTION_STRING }}"
            $json | ConvertTo-Json -Depth 10 | Set-Content $appSettingsPath -Encoding UTF8
            Write-Host "‚úÖ ConnectionStrings.Default updated"
          } else {
            Write-Host "‚ö†Ô∏è ConnectionStrings.Default not found!"
            exit 1
          }

      # 6) Build
      - name: üõ† Build
        run: dotnet build --configuration Release --no-restore

      # 7) Publish into $GITHUB_WORKSPACE/publish
      - name: üöÄ Publish ShipInfo.WebAPI
        run: dotnet publish ./ShipInfo.WebAPI/ShipInfo.WebAPI.csproj `
              --configuration Release `
              --output "$GITHUB_WORKSPACE/publish" `
              --runtime win-x86

      # 8) Debug: content listing publish
      - name: üìÇ List publish output
        run: dir "$GITHUB_WORKSPACE/publish"

      # 9) Create a local api folder in publish
      - name: üóÑ Create local wwwroot/api folder
        shell: pwsh
        run: |
          $apiDir = Join-Path $Env:GITHUB_WORKSPACE 'publish\api'
          if (-not (Test-Path $apiDir)) {
            New-Item -ItemType Directory -Path $apiDir | Out-Null
            Write-Host "‚úÖ Created: $apiDir"
          } else {
            Write-Host "‚ÑπÔ∏è Already exists: $apiDir"
          }

      # 10) Tests
      - name: ‚úÖ Test with .NET
        run: dotnet test

      # 11) Deploy
      - name: üöÄ Deploy to MonsterASP.NET
        uses: rasmusbuchholdt/simply-web-deploy@2.1.0
        with:
          website-name: ${{ secrets.WEBSITE_NAME }}
          server-computer-name: ${{ secrets.SERVER_COMPUTER_NAME }}
          server-username: ${{ secrets.SERVER_USERNAME }}
          server-password: ${{ secrets.SERVER_PASSWORD }}
          # Absolute path to local publish folder
          source-path: ${{ github.workspace }}/publish
          # Target folder on server (IIS/wwwroot/api)
          target-path: /api/
